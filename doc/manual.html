<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
	<title>Rollout Manual</title>
	<style>
		table {
			border: 1px solid lightgray;
			border-collapse: collapse;
		}

		table th {
			text-justify: left;
			font-weight: bold;
			background-color: lightblue;
			border: 1px solid lightgray;
		}

		table td {
			border: 1px solid lightgray;
		}
	</style>
</head>

<body>

<h1>Rollout</h1>

<h2>Introduction</h2>

<p>Rollout is a system developed to manage UNIX servers. It is primarily
focused towards Linux, but could be adapted to Solaris, HP-UX, AIX, etc.</p>

<p>It is written purely in Perl, and the configuration is also a Perl source
file. Some Perl knowledge is required to edit the configuration, but
copy-and-paste will probably suffice.</p>

<h2>Overview</h2>

<p>System Administration can generally be reduced to a set of steps, which must
be completed in order. Some example steps include:</p>

<ul>
	<li>Copy files, create symlinks</li>
	<li>Edit configuration files</li>
	<li>Start / stop services</li>
	<li>Add / modify users &amp; groups</li>
	<li>Install applications</li>
</ul> 

<p>The idea behind Rollout is to automate all these steps in a configurable
way. Rollout is by design indempotent - it can be run many times on a single
server and produce the same results.</p>

<h2>Running Rollout</h2>

<p>Rollout is self-installing on servers. The following command line will
install rollout for the first time:</p>

<pre>URL=http://rollout.localdomain; wget -O- $URL/rollout | perl - -s -u $URL</pre>

<p>After it's installed, it can be run just by calling <code>rollout</code>.
You must however give a comment on the rollout command line. This should be a
short reason for running Rollout.</p>

<p>The first run uses the <code>-s</code> flag, which runs rollout in <em>safe
	mode</em>. In this mode, all the steps are run but no changes are
actually made. This is used to check that nothing bad will happen when it's run
for real.</p>

<p>After the safe mode run has been checked, it can be run again without the
<code>-s</code> flag, and all steps will be applied.</p>

<p><b>NOTE:</b> The first run requires the <code>Net::HTTP</code> perl module
to already be installed. This is part of the <code>libwww-perl</code> package
in Debian based distributions.</p>

<h2>Command-line Arguments</h2>

<p>The following command line arguments are available:</p>

<table>
<tr>
	<th>Full</th>
	<th>Short</th>
	<th>Description</th>
</tr>
<tr>
	<td>verbose</td>
	<td>v</td>
	<td>Increase verbosity</td>
</tr>
<tr>
	<td>quiet</td>
	<td>q</td>
	<td>Don't print anything except fatal errors</td>
</tr>
<tr>
	<td>safe_mode</td>
	<td>s</td>
	<td>Show what will be changed, but don't actually do anything</td>
</tr>
<tr>
	<td>url</td>
	<td>u</td>
	<td>Set the base Rollout HTTP url. This defaults to <code>http://rollout.domain</code>. This option is saved in the rollout script, so only needs to be specified once.</td>
</tr>
<tr>
	<td>skip_step</td>
	<td>k</td>
	<td>Specify a step to be skipped, may be specified multiple times. e.g. <code>-k network -k sysctl</code></td>
</tr>
<tr>
	<td>hostname</td>
	<td>h</td>
	<td>Rollout configuration for a different host. If <code>-f network</code> is provided, the hostname will be changed to match the host supplied</td>
</tr>
<tr>
	<td>force</td>
	<td>f</td>
	<td>Force a dangerous step to be run. e.g. <code>-f network</code></td>
</tr>
</table>

<h2>Logging</h2>

<p>Every Rollout run that is run without the <code>-s</code> flag will be
logged by the 99-complete step. The default is to make a HTTP request to the
rollout server and pass it the log. The sample <code>complete.php</code> script
will receive the log and do nothing with it.</p>

<h2>Configuration</h2>

<p>The entire configuration for Rollout is stored in <code>rollout.cfg</code>.
This file is a Perl source file, so it can be checked for correctness by
running <code>perl -c rollout.cfg</code>.</p>

<p>A major design concept in the rollout configuration is <em>inheritance</em>.
Since many devices will have similar configurations, they should inherit as
much as possible using the <code>ISA</code> configuration item. Each class in
the <code>ISA</code> section is also specified in the same config, and they can
inherit from other classes. It's even possible to have a device directly
inherit another device's configuration, but this would include everything, even
network interfaces.</p>

<p>The only thing that needs to be changed in the file is the <code>%m</code>
hash, which contains configuration for everything. A sample device
configuration looks like this:</p>

<pre>
kickstart => {
  ISA => { RHEL4_i386 => 1, Web_Server => 1 }, # Inherit the RHEL4_i386 and Web_Server classes
  interfaces => {
    eth0 => {
      dhcp => 'kickstart',                     # eth0 gets its IP by DHCP
      mac => '00:50:8B:E8:A0:6D',
      primary => 1,
    },
    eth1 => {
      ip => '10.0.0.1',                        # eth1 is statically defined on its own network
      netmask => '255.255.255.0',
      mac => '00:D0:B7:E3:5A:F4',
    },
  },
  nfs_share => {
    "/kickstart" => {                          # Share the /kickstart directory by NFS
      "10.0.0.0/24" => "ro,no_root_squash",    # Allow the private LAN to access the nfs share
    },
  },
  firewall_allow => [;
    '# Rollout HTTP', # This comment is inserted directly into the rules list
    any => '8140',    # Allow any host to connect to tcp port 8140
    admin => '80',    # Allow the admin network to connect to tcp port 80
  ],
  packages => [;
    'dhcp',           # Make sure the dhcp and rpm-devel packages are installed
    'rpm-devel',
  ],
},
</pre>

<h2>Configuration Items</h2>

<p>The following items are available for use in <code>rollout.cfg</code>:</p>

<table><tr>
	<th>Item</th>
	<th>Type</th>
	<th>Description</th>
</tr>
<tr>
	<td>apt_base</td>
	<td>string</td>
	<td>Specifies a URL that will be added to the APT sources.list for local packages</td>
</tr>
<tr>
	<td>crontab</td>
	<td>hash</td>
	<td>A hash of cron.d files that will be created, with the entries for each file</td>
</tr>
<tr>
	<td>cvs</td>
	<td>cvs</td>
	<td>Specifies which modules will be checked out of CVS, and where</td>
</tr>
<tr>
	<td>deb_options</td>
	<td>list</td>
	<td>Allows preconfiguring deb packages before they are installed. <em>Expert Option</em></td>
</tr>
<tr>
	<td>dir_check</td>
	<td>list</td>
	<td>Creates directories and forces ownership &amp; permissions</td>
</tr>
<tr>
	<td>file_append</td>
	<td>list</td>
	<td>Appends lines to text files, replacing any lines that match. Can also run a command if the file is changed</td>
</tr>
<tr>
	<td>file_attr</td>
	<td>hash</td>
	<td>Modifies owner, group and permissions on files</td>
</tr>
<tr>
	<td>file_extract</td>
	<td>hash</td>
	<td>Downloads a tarball and extracts it to a directory</td>
</tr>
<tr>
	<td>file_install</td>
	<td>hash</td>
	<td>Downloads a file and places it somewhere. Can also run a command if the file is changed</td>
</tr>
<tr>
	<td>file_modify</td>
	<td>list</td>
	<td>Modifies existing files by applying regular expressions. Can also run a command if the file is changed</td>
</tr>
<tr>
	<td>firewall_allow</td>
	<td>list</td>
	<td>Allows incoming ports in the firewall</td>
</tr>
<tr>
	<td>firewall_append</td>
	<td>list</td>
	<td>Appends verbatim lines to the iptables configuration file</td>
</tr>
<tr>
	<td>firewall_deny</td>
	<td>list</td>
	<td>Denies incoming ports in the firewall</td>
</tr>
<tr>
	<td>group</td>
	<td>hash</td>
	<td>Ensures a system group exists</td>
</tr>
<tr>
	<td>hosts_append</td>
	<td>list</td>
	<td>Appends a given line to the <code>/etc/hosts</code> file</td>
</tr>
<tr>
	<td>immutable_file</td>
	<td>list</td>
	<td>Marks a certain file as immutable. This file will never be touched by any other steps</td>
</tr>
<tr>
	<td>interfaces</td>
	<td>hash</td>
	<td>Defines configuration for the network interfaces</td>
</tr>
<tr>
	<td>ISA</td>
	<td>hash</td>
	<td>Specifies a list of classes that this device or class inherits configuration from</td>
</tr>
<tr>
	<td>nameservers</td>
	<td>list</td>
	<td>Specifies the default nameservers in <code>/etc/resolv.conf</code></td>
</tr>
<tr>
	<td>network</td>
	<td>string</td>
	<td>Marks the device or class as part of a network, for the purposes of firewalls and host files</td>
</tr>
<tr>
	<td>nfs_mount</td>
	<td>hash</td>
	<td>Mounts a NFS share locally</td>
</tr>
<tr>
	<td>nfs_share</td>
	<td>hash</td>
	<td>Shares a local directory by NFS</td>
</tr>
<tr>
	<td>packages</td>
	<td>list</td>
	<td>Provides a list of packages to be installed. These can be debs or rpms</td>
</tr>
<tr>
	<td>port_check</td>
	<td>list</td>
	<td>Adds elements to <code>/etc/services</code></td>
</tr>
<tr>
	<td>service</td>
	<td>hash</td>
	<td>Ensures that system services are running/stopped and should be started/stopped on boot</td>
</tr>
<tr>
	<td>skip_steps</td>
	<td>list</td>
	<td>Mark a list of steps that will never be executed for this device</td>
</tr>
<tr>
	<td>sudo</td>
	<td>hash</td>
	<td>Allow users to run commands with sudo</td>
</tr>
<tr>
	<td>ssh_keys_add</td>
	<td>list</td>
	<td>Adds the list of keys to root's <code>authorized_keys</code> file</td>
</tr>
<tr>
	<td>symlink_check</td>
	<td>hash</td>
	
	<td>Ensures a symlink exists and its destination is correct</td>
</tr>
<tr>
	<td>sysctl</td>
	<td>hash</td>
	<td>Adds the items to <code>/etc/sysctl.conf</code> and applies them. These are for kernel configuration</td>
</tr>
<tr>
	<td>user</td>
	<td>string</td>
	<td>Ensures each user exists, has the correct password and is in the correct groups</td>
</tr>
</table>

<h2>Sample Run</h2>

<p>The following is pasted directly from the terminal after running Rollout on freemantle:</p>

<pre>
01-setup
02-network
  Installing /etc/network/interfaces from text
  Modified /etc/resolv.conf by appending options timeout:5 attempts:2
  Network config is considered dangerous, changes won't be applied unless you specify the "-f network" argument.
03-hosts
  Modified /etc/hosts by appending 172.16.40.54 mulberry
  Modified /etc/hosts by appending 172.16.40.184 kickstart
05-users
06-ssh_keys
  Installing /root/.ssh/authorized_keys from text
  Changing mode of /root/.ssh/authorized_keys to 644
15-packages
  Installing packages lshw
16-gpg
20-sysctl
  Modified /etc/sysctl.conf by appending net.ipv4.conf.all.log_martians = 1
  Modified /etc/sysctl.conf by appending net.ipv4.conf.all.accept_redirects = 0
  Modified /etc/sysctl.conf by appending net.ipv4.conf.all.send_redirects = 0
  Modified /etc/sysctl.conf by appending net.ipv4.conf.all.rp_filter = 1
  Modified /etc/sysctl.conf by appending net.ipv4.icmp_echo_ignore_broadcasts = 0
  Modified /etc/sysctl.conf by appending net.ipv4.tcp_syncookies = 1
  Modified /etc/sysctl.conf by appending net.ipv4.conf.all.accept_source_route = 0
21-cvs
24-dir_check
24-file_extract
25-file_install
  Installing /etc/pam_ldap.conf from http://rollout.domain/conf/pam_ldap.conf
  Installing /etc/libnss-ldap.conf from http://rollout.domain/conf/libnss-ldap.conf
  Changing mode of /etc/libnss-ldap.conf to 600
  Installing /etc/ntp.conf from http://rollout.domain/conf/ntp.conf
  Installing /etc/resolv.conf from http://rollout.domain/conf/resolv.conf
  Changing target of symlink /usr/local/bin/vis to /usr/local/bin/viw
27-port_check
70-nfs
80-file_append
80-file_modify
  Modified /etc/nsswitch.conf with s/^passwd:.*/passwd:  compat ldap/, s/^group:.*/group:  compat ldap/
80-file_uncomment
85-cron
90-services
99-complete
</pre>

<h2>Steps</h2>

<table width='100%'>

	<tr valign='top'>
		<th>Step</th>
		<th>Description</th>
	</tr>

	<tr valign='top'>
		<td width='1% nowrap'>01-setup</td>
		<td>
			<li>Installs rollout locally</li>
			<li>Downloads and parses the <code>rollout.cfg</code> configuration file</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td width='1% nowrap'>02-network</td>
		<td>
			<li>Checks the <code>interfaces</code> configuration item</li>
			<li><strong>This is a dangerous step and will always be run in safe mode unless <code>-f network</code> is specified</strong></li>
			<li>On RedHat:
				<ul>
					<li>Creates a file called /etc/sysconfig/network-interfaces/ifcfg-* for each interface.</li>
				</ul>
			</li>
			<li>On Debian / Ubuntu:
				<ul>
					<li>Creates the single file /etc/network/interfaces containing configuration for every interface.</li>
				</ul>
			</li>
			<li>Sets the device's hostname if <code>-h _hostname_</code> is specified</li>
			<li>Applies the <code>skip_steps</code> configuration item</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td width='1% nowrap'>03-hosts</td>
		<td>
			<li>Adds addresses to <code>/etc/hosts</code> for every device in this device's network.</li>
			<li>Uses the <code>hosts_append</code> and <code>network</code> configuration items.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td width='1% nowrap'>05-users</td>
		<td>
			<li>Creates and modifies users and groups.</li>
			<li>Uses the <code>user</code> and <code>group</code> configuration items.</li>
			<li>This will set a user's password on creation, but will not reset it if changed locally.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>06-ssh_keys</td>
		<td>
			<li>Creates and updates <code>~/.ssh/authorized_keys</code> for every user, including root.</li>
			<li>Adds ssh keys for each user based on the <code>user =&gt; { ssh_keys =&gt; [] }</code> configuration item.</li>
			<li>Adds ssh keys for root based on the <code>ssh_keys_add</code> configuration item.</li>
			<li>The ssh keys are taken from the <code>rollout:conf/authorized_keys</code> file based on comment.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>15-packages</td>
		<td>
			<li>Installs and removes packages as specified in the <code>packages</code> config item.</li>
			<li>Applies deb configuration items as specified in the <code>deb_options</code> config item.</li>
			<li>Adds <code>apt_base</code> items to the apt sources.list</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>16-gpg</td>
		<td>
			<li>Adds required ssh public keys to root's public keyring</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>20-sysctl</td>
		<td>
			<li>Adds all items in <code>sysctl</code> the config item to <code>/etc/sysctl.conf</code> and applies them.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>21-cvs</td>
		<td>
			<li>Checks out any cvs modules as specified in the <code>cvs</code> config item.</li>
			<li>If the directory already exists, it is checked for CVS files. If they don't exist already, it is a fatal error.</li>
			<li>If the directory is an existing checkout, the directory will be updated by cvs.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>24-dir_check</td>
		<td>
			<li>Creates any directories as specified in the <code>dir_check</code> config item.</li>
			<li>Each directory is checked for owner and permissions.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>24-file_extract</td>
		<td>
			<li>Extracts any tarballs given in the <code>file_extract</code> config item.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>25-file_install</td>
		<td>
			<li>Installs individual files specified in the <code>file_install</code> config item.</li>
			<li>Optionally runs a command if the file has changed.</li>
			<li>Creates symlinks specified in the <code>symlink_check</code> config item and ensures the destination is correct.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>27-port_check</td>
		<td>
			<li>Adds items in the <code>port_check</code> configuration item to <code>/etc/services</code></li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>60-sudo</td>
		<td>
			<li>Creates /etc/sudoers allowing users to run commands as root, with the configuration in the <code>sudo</code> item.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>70-nfs</td>
		<td>
			<li>Configures both nfs client and server, as specified in the <code>nfs_mount</code> and <code>nfs_share</code> config items.</li>
			<li>Forces the required packages to be installed to support a nfs client and/or server.</li>
			<li>Creates directories for any nfs client mountpoints.</li>
			<li>Configures nfs, portmap, sunrpc, etc to run on predefined ports.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>80-file_append</td>
		<td>
			<li>Appends lines to existing configuration files as specified in the <code>file_append</code> config item.</li>
			<li>Optionally runs a command if the file has been changed.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>80-file_modify</td>
		<td>
			<li>Applies regular expression changes to files given in the <code>file_modify</code> config item.</li>
			<li>Optionally runs a command if the file has been changed.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>80-file_uncomment</td>
		<td>
			<li>Uncomments out lines in a configuration files matching regular expressions in the <code>file_uncomment</code> config item.</li>
			<li>Lines are uncommented by removing a leading "#"</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>81-file_attr</td>
		<td>
			<li>Change the owner, group and permissions of files as controlled by the <code>file_attr</code> config item.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>85-cron</td>
		<td>
			<li>Creates a cron.d file for each item specified in the <code>crontab</code> config item.</li>
			<li>The created file will contain only the items specified in the config.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>90-services</td>
		<td>
			<li>Starts and stops services specified in the <code>services</code> config item.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>95-iptables</td>
		<td>
			<li>Creates the iptables configuration file. The location of this file varies from system to system. The format of the file is what is required by <code>iptables-restore</code>.</li>
			<li>The file is made up of default rules, <code>firewall_deny</code> rules, <code>firewall_append</code> lines and <code>firewall_allow</code> rules, in that order.</li>
			<li>If the config file has changed, runs <code>iptables-restore</code> on it to load the new rules.</li>
		</td> 
	</tr>

	<tr valign='top'>
		<td>99-complete</td>
		<td>
			<li>Log the run in <code>/var/log/rollout.log</code></li>
			<li>Send a copy of the log to the kickstart web server.</li>
		</td> 
	</tr>
</table>

</html>
</body>
